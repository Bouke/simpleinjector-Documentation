

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ASP.NET Web API Integration Guide &mdash; Simple Injector 2 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="Simple Injector 2 documentation" href="index.html"/>
        <link rel="up" title="Integration Guide" href="integration.html"/>
        <link rel="next" title="ASP.NET Web Forms Integration Guide" href="webformsintegration.html"/>
        <link rel="prev" title="ASP.NET MVC Integration Guide" href="mvcintegration.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="index.html" class="fa fa-home"> Simple Injector</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quick Start</a><ul>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#getting-started">Getting started</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#a-quick-example">A Quick Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#more-information">More information</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="using.html">Using Simple Injector</a><ul>
<li class="toctree-l2"><a class="reference internal" href="using.html#resolving-instances">Resolving instances</a></li>
<li class="toctree-l2"><a class="reference internal" href="using.html#configuring-simple-injector">Configuring Simple Injector</a></li>
<li class="toctree-l2"><a class="reference internal" href="using.html#collections">Collections</a></li>
<li class="toctree-l2"><a class="reference internal" href="using.html#verifying-the-container-s-configuration">Verifying the container&#8217;s configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="using.html#automatic-constructor-injection-auto-wiring">Automatic constructor injection / auto-wiring</a></li>
<li class="toctree-l2"><a class="reference internal" href="using.html#more-information">More information</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="lifetimes.html">Object Lifetime Management</a><ul>
<li class="toctree-l2"><a class="reference internal" href="lifetimes.html#transient">Transient</a></li>
<li class="toctree-l2"><a class="reference internal" href="lifetimes.html#singleton">Singleton</a></li>
<li class="toctree-l2"><a class="reference internal" href="lifetimes.html#scoped">Scoped</a></li>
<li class="toctree-l2"><a class="reference internal" href="lifetimes.html#per-web-request">Per Web Request</a></li>
<li class="toctree-l2"><a class="reference internal" href="lifetimes.html#per-web-api-request">Per Web API Request</a></li>
<li class="toctree-l2"><a class="reference internal" href="lifetimes.html#web-api-request-lifestyle-vs-web-request-lifestyle">Web API Request lifestyle vs. Web Request lifestyle</a></li>
<li class="toctree-l2"><a class="reference internal" href="lifetimes.html#per-wcf-operation">Per WCF Operation</a></li>
<li class="toctree-l2"><a class="reference internal" href="lifetimes.html#per-lifetime-scope">Per Lifetime Scope</a></li>
<li class="toctree-l2"><a class="reference internal" href="lifetimes.html#per-execution-context-scope-async-await">Per Execution Context Scope (async/await)</a></li>
<li class="toctree-l2"><a class="reference internal" href="lifetimes.html#per-graph">Per Graph</a></li>
<li class="toctree-l2"><a class="reference internal" href="lifetimes.html#instance-per-dependency">Instance Per Dependency</a></li>
<li class="toctree-l2"><a class="reference internal" href="lifetimes.html#per-thread">Per Thread</a></li>
<li class="toctree-l2"><a class="reference internal" href="lifetimes.html#per-http-session">Per HTTP Session</a></li>
<li class="toctree-l2"><a class="reference internal" href="lifetimes.html#hybrid">Hybrid</a></li>
<li class="toctree-l2"><a class="reference internal" href="lifetimes.html#developing-a-custom-lifestyle">Developing a Custom Lifestyle</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="integration.html">Integration Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="aspnetintegration.html">ASP.NET Core (beta!)</a></li>
<li class="toctree-l2"><a class="reference internal" href="mvcintegration.html">ASP.NET MVC</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">ASP.NET Web API</a></li>
<li class="toctree-l2"><a class="reference internal" href="webformsintegration.html">ASP.NET Web Forms</a></li>
<li class="toctree-l2"><a class="reference internal" href="owinintegration.html">OWIN</a></li>
<li class="toctree-l2"><a class="reference internal" href="windowsformsintegration.html">Windows Forms</a></li>
<li class="toctree-l2"><a class="reference internal" href="wcfintegration.html">WCF</a></li>
<li class="toctree-l2"><a class="reference internal" href="wpfintegration.html">WPF</a></li>
<li class="toctree-l2"><a class="reference internal" href="silverlightintegration.html">Silverlight</a></li>
<li class="toctree-l2"><a class="reference internal" href="integration.html#patterns">Patterns</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="diagnostics.html">Diagnostic Services</a><ul>
<li class="toctree-l2"><a class="reference internal" href="diagnostics.html#how-to-view-diagnostic-results">How to view diagnostic results</a></li>
<li class="toctree-l2"><a class="reference internal" href="diagnostics.html#suppressing-warnings">Suppressing warnings</a></li>
<li class="toctree-l2"><a class="reference internal" href="diagnostics.html#limitations">Limitations</a></li>
<li class="toctree-l2"><a class="reference internal" href="diagnostics.html#supported-warnings">Supported Warnings</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="howto.html">How To</a><ul>
<li class="toctree-l2"><a class="reference internal" href="howto.html#register-factory-delegates">Register factory delegates</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto.html#resolve-instances-by-key">Resolve instances by key</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto.html#register-multiple-interfaces-with-the-same-implementation">Register multiple interfaces with the same implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto.html#override-existing-registrations">Override existing registrations</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto.html#verify-the-container-s-configuration">Verify the container&#8217;s configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto.html#work-with-dependency-injection-in-multi-threaded-applications">Work with dependency injection in multi-threaded applications</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="advanced.html">Advanced Scenarios</a><ul>
<li class="toctree-l2"><a class="reference internal" href="advanced.html#generics">Generics</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced.html#batch-automatic-registration">Batch / Automatic registration</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced.html#registration-of-open-generic-types">Registration of open generic types</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced.html#mixing-collections-of-open-generic-and-non-generic-components">Mixing collections of open-generic and non-generic components</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced.html#unregistered-type-resolution">Unregistered type resolution</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced.html#context-based-injection">Context based injection</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced.html#decorators">Decorators</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced.html#interception">Interception</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced.html#property-injection">Property injection</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced.html#covariance-and-contravariance">Covariance and Contravariance</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced.html#registering-plugins-dynamically">Registering plugins dynamically</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="extensibility.html">Extensibility Points</a><ul>
<li class="toctree-l2"><a class="reference internal" href="extensibility.html#overriding-constructor-resolution-behavior">Overriding Constructor Resolution Behavior</a></li>
<li class="toctree-l2"><a class="reference internal" href="extensibility.html#overriding-property-injection-behavior">Overriding Property Injection Behavior</a></li>
<li class="toctree-l2"><a class="reference internal" href="extensibility.html#overriding-parameter-injection-behavior">Overriding Parameter Injection Behavior</a></li>
<li class="toctree-l2"><a class="reference internal" href="extensibility.html#resolving-unregistered-types">Resolving Unregistered Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="extensibility.html#overriding-lifestyle-selection-behavior">Overriding Lifestyle Selection Behavior</a></li>
<li class="toctree-l2"><a class="reference internal" href="extensibility.html#intercepting-the-creation-of-types">Intercepting the Creation of Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="extensibility.html#building-up-external-instances">Building up External Instances</a></li>
<li class="toctree-l2"><a class="reference internal" href="extensibility.html#interception-of-resolved-object-graphs">Interception of Resolved Object Graphs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="pipeline.html">Simple Injector Pipeline</a><ul>
<li class="toctree-l2"><a class="reference internal" href="pipeline.html#registration-pipeline">Registration Pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="pipeline.html#resolve-pipeline">Resolve Pipeline</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="principles.html">Design Principles</a><ul>
<li class="toctree-l2"><a class="reference internal" href="principles.html#make-simple-use-cases-easy-make-complex-use-cases-possible">Make simple use cases easy, make complex use cases possible</a></li>
<li class="toctree-l2"><a class="reference internal" href="principles.html#push-developers-into-best-practices">Push developers into best practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="principles.html#fast-by-default">Fast by default</a></li>
<li class="toctree-l2"><a class="reference internal" href="principles.html#don-t-force-vendor-lock-in">Don&#8217;t force vendor lock-in</a></li>
<li class="toctree-l2"><a class="reference internal" href="principles.html#never-fail-silently">Never fail silently</a></li>
<li class="toctree-l2"><a class="reference internal" href="principles.html#features-should-be-intuitive">Features should be intuitive</a></li>
<li class="toctree-l2"><a class="reference internal" href="principles.html#communicate-errors-clearly-and-describe-how-to-solve-them">Communicate errors clearly and describe how to solve them</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="decisions.html">Design Decisions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="decisions.html#the-container-is-locked-after-the-first-call-to-resolve">The container is locked after the first call to resolve</a></li>
<li class="toctree-l2"><a class="reference internal" href="decisions.html#the-api-clearly-differentiates-the-registration-of-collections">The API clearly differentiates the registration of collections</a></li>
<li class="toctree-l2"><a class="reference internal" href="decisions.html#no-support-for-xml-based-configuration">No support for XML based configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="decisions.html#never-force-users-to-release-what-they-resolve">Never force users to release what they resolve</a></li>
<li class="toctree-l2"><a class="reference internal" href="decisions.html#don-t-allow-resolving-scoped-instances-outside-an-active-scope">Don&#8217;t allow resolving scoped instances outside an active scope</a></li>
<li class="toctree-l2"><a class="reference internal" href="decisions.html#no-out-of-the-box-support-for-property-injection">No out-of-the-box support for property injection</a></li>
<li class="toctree-l2"><a class="reference internal" href="decisions.html#no-out-of-the-box-support-for-interception">No out-of-the-box support for interception</a></li>
<li class="toctree-l2"><a class="reference internal" href="decisions.html#limited-batch-registration-api">Limited batch-registration API</a></li>
<li class="toctree-l2"><a class="reference internal" href="decisions.html#no-per-thread-lifestyle">No per-thread lifestyle</a></li>
<li class="toctree-l2"><a class="reference internal" href="decisions.html#allow-only-a-single-constructor">Allow only a single constructor</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="legal.html">Legal stuff</a><ul>
<li class="toctree-l2"><a class="reference internal" href="legal.html#simple-injector-license">Simple Injector License</a></li>
<li class="toctree-l2"><a class="reference internal" href="legal.html#contributions">Contributions</a></li>
<li class="toctree-l2"><a class="reference internal" href="legal.html#simple-injector-trademark-policy">Simple Injector Trademark Policy</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="contribute.html">How to Contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendix.html">Appendix</a><ul>
<li class="toctree-l2"><a class="reference internal" href="InterceptionExtensions.html">Interception Extensions</a></li>
<li class="toctree-l2"><a class="reference internal" href="varianceextensions.html">Variance Extensions</a></li>
<li class="toctree-l2"><a class="reference internal" href="t4mvc.html">T4MVC</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="https://simpleinjector.org/ReferenceLibrary/">API Documentation</a></li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Simple Injector</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
          <li><a href="integration.html">Integration Guide</a> &raquo;</li>
      
    <li>ASP.NET Web API Integration Guide</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="_sources/webapiintegration.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <div class="section" id="asp-net-web-api-integration-guide">
<h1>ASP.NET Web API Integration Guide<a class="headerlink" href="#asp-net-web-api-integration-guide" title="Permalink to this headline">¶</a></h1>
<p>Simple Injector contains <a class="reference external" href="https://www.nuget.org/packages/SimpleInjector.Integration.WebApi.WebHost.QuickStart">Simple Injector ASP.NET Web API Integration Quick Start NuGet package for IIS-hosted applications</a>. If you&#8217;re not using NuGet, you must include both the <strong>SimpleInjector.Integration.WebApi.dll</strong> and <strong>SimpleInjector.Extensions.ExecutionContextScoping.dll</strong> in your Web API application, which is part of the standard download on Github.</p>
<div class="note container">
<strong>Note</strong>: To be able to run the Web API integration packages, <a class="reference external" href="https://stackoverflow.com/questions/22392032/are-there-any-technical-reasons-simpleinjector-cannot-support-webapi-on-net-4-0">you need</a> <em>.NET 4.5</em> or above.</div>
<div class="section" id="basic-setup">
<span id="web-api-basic-setup"></span><h2>Basic setup<a class="headerlink" href="#basic-setup" title="Permalink to this headline">¶</a></h2>
<p>The following code snippet shows how to use the integration package (note that the quick start package injects this code for you).</p>
<div class="highlight-c#"><div class="highlight"><pre><span class="c1">// You&#39;ll need to include the following namespaces</span>
<span class="k">using</span> <span class="nn">System.Web.Http</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">SimpleInjector</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">SimpleInjector.Integration.WebApi</span><span class="p">;</span>

<span class="c1">// This is the Application_Start event from the Global.asax file.</span>
<span class="k">protected</span> <span class="k">void</span> <span class="nf">Application_Start</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Create the container as usual.</span>
    <span class="kt">var</span> <span class="n">container</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Container</span><span class="p">();</span>
    <span class="n">container</span><span class="p">.</span><span class="n">Options</span><span class="p">.</span><span class="n">DefaultScopedLifestyle</span> <span class="p">=</span> <span class="k">new</span> <span class="n">WebApiRequestLifestyle</span><span class="p">();</span>

    <span class="c1">// Register your types, for instance using the scoped lifestyle:</span>
    <span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IUserRepository</span><span class="p">,</span> <span class="n">SqlUserRepository</span><span class="p">&gt;(</span><span class="n">Lifestyle</span><span class="p">.</span><span class="n">Scoped</span><span class="p">);</span>

    <span class="c1">// This is an extension method from the integration package.</span>
    <span class="n">container</span><span class="p">.</span><span class="n">RegisterWebApiControllers</span><span class="p">(</span><span class="n">GlobalConfiguration</span><span class="p">.</span><span class="n">Configuration</span><span class="p">);</span>

    <span class="n">container</span><span class="p">.</span><span class="n">Verify</span><span class="p">();</span>

    <span class="n">GlobalConfiguration</span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="n">DependencyResolver</span> <span class="p">=</span>
        <span class="k">new</span> <span class="nf">SimpleInjectorWebApiDependencyResolver</span><span class="p">(</span><span class="n">container</span><span class="p">);</span>

    <span class="c1">// Here your usual Web API configuration stuff.</span>
<span class="p">}</span>
</pre></div>
</div>
<p>With this configuration, ASP.NET Web API will create new <em>IHttpController</em> instances through the container. Because controllers are concrete classes, the container will be able to create them without any registration. However, to be able to <a class="reference internal" href="howto.html#verify-configuration"><em>verify</em></a> and <a class="reference internal" href="diagnostics.html"><em>diagnose</em></a> the container&#8217;s configuration, it is important to register all root types explicitly.</p>
<div class="note container">
<strong>Note</strong>: For Web API applications the use of the <strong>WebApiRequestLifestyle</strong> is advised over the <strong>WebRequestLifestyle</strong>. Please take a look at the <a class="reference internal" href="lifetimes.html#webapirequest-vs-webrequest"><em>Web API Request Object Lifestyle Management wiki page</em></a> for more information.</div>
<p>Given the configuration above, an actual controller could look like this:</p>
<div class="highlight-c#"><div class="highlight"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">UserController</span> <span class="p">:</span> <span class="n">ApiController</span> <span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IUserRepository</span> <span class="n">repository</span><span class="p">;</span>

    <span class="c1">// Use constructor injection here</span>
    <span class="k">public</span> <span class="nf">UserController</span><span class="p">(</span><span class="n">IUserRepository</span> <span class="n">repository</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">repository</span> <span class="p">=</span> <span class="n">repository</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="n">GetAllUsers</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">repository</span><span class="p">.</span><span class="n">GetAll</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">User</span> <span class="nf">GetUserById</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">repository</span><span class="p">.</span><span class="n">GetById</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">KeyNotFoundException</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">HttpResponseException</span><span class="p">(</span><span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">NotFound</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="extra-features">
<span id="web-api-extra-features"></span><h2>Extra features<a class="headerlink" href="#extra-features" title="Permalink to this headline">¶</a></h2>
<p>The basic features of the Web API integration package are the <strong>SimpleInjectorWebApiDependencyResolver</strong> class and the <strong>WebApiRequestLifestyle</strong> and <strong>RegisterWebApiControllers</strong> extension methods. Besides these basic features, the integration package contains extra features that can make your life easier.</p>
<div class="section" id="getting-the-current-request-s-httprequestmessage">
<span id="getting-the-current-requests-httprequestmessage"></span><h3>Getting the current request&#8217;s HttpRequestMessage<a class="headerlink" href="#getting-the-current-request-s-httprequestmessage" title="Permalink to this headline">¶</a></h3>
<p>When working with Web API you will often find yourself wanting access to the current <em>HttpRequestMessage</em>. Simple Injector allows fetching the current <em>HttpRequestMessage</em> by calling the <em>container.GetCurrentHttpRequestMessage()</em> extension method. To be able to request the current <em>HttpRequestMessage</em> you need to explicitly enable this as follows:</p>
<div class="highlight-c#"><div class="highlight"><pre><span class="n">container</span><span class="p">.</span><span class="n">EnableHttpRequestMessageTracking</span><span class="p">(</span><span class="n">GlobalConfiguration</span><span class="p">.</span><span class="n">Configuration</span><span class="p">);</span>
</pre></div>
</div>
<p>There are several ways to get the current <em>HttpRequestMessage</em> in your services, but since it is discouraged to inject the <em>Container</em> itself into any services, the best way is to define an abstraction for this. For instance:</p>
<div class="highlight-c#"><div class="highlight"><pre><span class="k">public</span> <span class="k">interface</span> <span class="n">IRequestMessageProvider</span> <span class="p">{</span>
    <span class="n">HttpRequestMessage</span> <span class="n">CurrentMessage</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This abstraction can be injected into your services, which can call the <em>CurrentMessage</em> property to get the <em>HttpRequestMessage</em>. Close to your DI configuration you can now create an implementation for this interface as follows:</p>
<div class="highlight-c#"><div class="highlight"><pre><span class="k">private</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">RequestMessageProvider</span> <span class="p">:</span> <span class="n">IRequestMessageProvider</span> <span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">Container</span> <span class="n">container</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">RequestMessageProvider</span><span class="p">(</span><span class="n">Container</span> <span class="n">container</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">container</span> <span class="p">=</span> <span class="n">container</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">HttpRequestMessage</span> <span class="n">CurrentMessage</span> <span class="p">{</span>
        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">container</span><span class="p">.</span><span class="n">GetCurrentHttpRequestMessage</span><span class="p">();</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This implementation can be implemented as follows:</p>
<div class="highlight-c#"><div class="highlight"><pre><span class="n">container</span><span class="p">.</span><span class="n">RegisterSingleton</span><span class="p">&lt;</span><span class="n">IRequestMessageProvider</span><span class="p">&gt;(</span><span class="k">new</span> <span class="n">RequestMessageProvider</span><span class="p">(</span><span class="n">container</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="section" id="injecting-dependencies-into-web-api-filter-attributes">
<span id="id1"></span><h3>Injecting dependencies into Web API filter attributes<a class="headerlink" href="#injecting-dependencies-into-web-api-filter-attributes" title="Permalink to this headline">¶</a></h3>
<p>Web API caches filter attribute instances indefinitely per action, effectively making them singletons. This makes them unsuited for dependency injection, since the attribute&#8217;s dependencies will be accidentally promoted to singleton as well, which can cause all sorts of concurrency issues.</p>
<p>Since dependency injection is not an option here, an other mechanism is advised. There are basically two options here. Which one is best depends on the amount of filter attributes your application needs. If the number of attributes is limited (to a few), the simplest solution is to revert to the Service Locator pattern within your attributes. If the number of attributes is larger, it might be better to make attributes passive.</p>
<p>Reverting to the Service Locator pattern means that you need to do the following:</p>
<ul class="simple">
<li>Extract all the attribute&#8217;s logic -with its dependencies- into a new service class.</li>
<li>Resolve this service from within the filter attribute&#8217;s <cite>OnActionExecXXX</cite> methods, but don&#8217;t store the resolved service in a private field.</li>
<li>Call the service&#8217;s method.</li>
</ul>
<p>The following example visualizes this:</p>
<div class="highlight-c#"><div class="highlight"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">MinimumAgeActionFilter</span> <span class="p">:</span> <span class="n">FilterAttribute</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">readonly</span> <span class="kt">int</span> <span class="n">MinimumAge</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">MinimumAgeActionFilter</span><span class="p">(</span><span class="kt">int</span> <span class="n">minimumAge</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">MinimumAge</span> <span class="p">=</span> <span class="n">minimumAge</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">override</span> <span class="n">Task</span> <span class="nf">OnActionExecutingAsync</span><span class="p">(</span><span class="n">HttpActionContext</span> <span class="n">actionContext</span><span class="p">,</span>
        <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">checker</span> <span class="p">=</span> <span class="n">GlobalConfiguration</span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="n">DependencyResolver</span>
            <span class="p">.</span><span class="n">GetService</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IMinimumAgeChecker</span><span class="p">))</span> <span class="k">as</span> <span class="n">IMinimumAgeChecker</span><span class="p">;</span>

        <span class="n">checker</span><span class="p">.</span><span class="n">VerifyCurrentUserAge</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">MinimumAge</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">TaskHelpers</span><span class="p">.</span><span class="n">Completed</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>By moving all the logic and dependencies out of the attribute, the attribute becomes a small infrastructural piece of code; a humble object that simply forwards the call to the real service.</p>
<p>If the number of required filter attributes grows, a different model might be in place. In that case you might want to make your attributes <a class="reference external" href="http://blog.ploeh.dk/2014/06/13/passive-attributes/">passive</a> as explained <a class="reference external" href="https://www.cuttingedge.it/blogs/steven/pivot/entry.php?id=98">here</a>.</p>
</div>
<div class="section" id="injecting-dependencies-into-web-api-message-handlers">
<span id="id2"></span><h3>Injecting dependencies into Web API message handlers<a class="headerlink" href="#injecting-dependencies-into-web-api-message-handlers" title="Permalink to this headline">¶</a></h3>
<p>The default mechanism in Web API to use HTTP Message Handlers to &#8216;decorate&#8217; requests is by adding them to the global <em>MessageHandlers</em> collection as shown here:</p>
<div class="highlight-c#"><div class="highlight"><pre><span class="n">GlobalConfiguration</span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="n">MessageHandlers</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">MessageHandler1</span><span class="p">());</span>
</pre></div>
</div>
<p>The problem with this approach is that this effectively hooks in the <em>MessageHandler1</em> into the Web API pipeline as a singleton. This is fine when the handler itself has no state and no dependencies, but in a system that is based on the SOLID design principles, it&#8217;s very likely that those handlers will have dependencies of their own and its very likely that some of those dependencies need a lifetime that is shorter than singleton.</p>
<p>If that&#8217;s the case, such message handler should not be created as singleton, since in general, a component should never have a lifetime that is longer than the lifetime of its dependencies.</p>
<p>The solution is to define a proxy class that sits in between. Since Web API lacks that functionality, we need to build this ourselves as follows:</p>
<div class="highlight-c#"><div class="highlight"><pre><span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">DelegatingHandlerProxy</span><span class="p">&lt;</span><span class="n">THandler</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">DelegatingHandler</span>
    <span class="k">where</span> <span class="n">THandler</span> <span class="p">:</span> <span class="n">DelegatingHandler</span> <span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">Container</span> <span class="n">container</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">DelegatingHandlerProxy</span><span class="p">(</span><span class="n">Container</span> <span class="n">container</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">container</span> <span class="p">=</span> <span class="n">container</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">override</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">HttpResponseMessage</span><span class="p">&gt;</span> <span class="n">SendAsync</span><span class="p">(</span>
        <span class="n">HttpRequestMessage</span> <span class="n">request</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// Important: Trigger the creation of the scope.</span>
        <span class="n">request</span><span class="p">.</span><span class="n">GetDependencyScope</span><span class="p">();</span>

        <span class="kt">var</span> <span class="n">handler</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">THandler</span><span class="p">&gt;();</span>

        <span class="k">if</span> <span class="p">(!</span><span class="kt">object</span><span class="p">.</span><span class="n">ReferenceEquals</span><span class="p">(</span><span class="n">handler</span><span class="p">.</span><span class="n">InnerHandler</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">InnerHandler</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">handler</span><span class="p">.</span><span class="n">InnerHandler</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">InnerHandler</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kt">var</span> <span class="n">invoker</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HttpMessageInvoker</span><span class="p">(</span><span class="n">handler</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">invoker</span><span class="p">.</span><span class="n">SendAsync</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This <em>DelegatingHandlerProxy&lt;THandler&gt;</em> can be added as singleton to the global <em>MessageHandlers</em> collection, and it will resolve the given <em>THandler</em> on each request, allowing it to be resolved according to its lifestyle.</p>
<p>The <em>DelegatingHandlerProxy&lt;THandler&gt;</em> can be used as follows:</p>
<div class="highlight-c#"><div class="highlight"><pre><span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">MessageHandler1</span><span class="p">&gt;();</span>

<span class="n">GlobalConfiguration</span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="n">MessageHandlers</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span>
    <span class="k">new</span> <span class="n">DelegatingHandlerProxy</span><span class="p">&lt;</span><span class="n">MessageHandler1</span><span class="p">&gt;(</span><span class="n">container</span><span class="p">));</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="webformsintegration.html" class="btn btn-neutral float-right" title="ASP.NET Web Forms Integration Guide"/>Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="mvcintegration.html" class="btn btn-neutral" title="ASP.NET MVC Integration Guide"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, Simple Injector Contributors.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>